# Plan de Reconstrucción Post-Rollback a v2.0.0

Este documento sirve como guía maestra para re-implementar de forma ordenada y estable las funcionalidades clave que se desarrollaron después de la versión 2.0.0, basándonos en la versión estable de `git`.

---

## 1. Módulo: Gestor de Notificaciones y Tareas Programadas (Cron)

### 1.1. Objetivo
La versión antigua ya contaba con el icono de la campana y notificaciones básicas. Lo que se debe reconstruir es el **módulo de administración** que permite una configuración avanzada.

### 1.2. Requisitos de UI
- **Página de Automatización (`/admin/notifications`):**
    - Una interfaz con dos pestañas: "Reglas de Notificación" y "Tareas Programadas".
    - **Reglas:** Permite crear una regla que se dispara por un evento del sistema (ej: 'onDispatchCompleted') y ejecuta una acción (ej: 'sendEmail'). Debe permitir configurar destinatarios, asunto, etc.
    - **Tareas:** Permite crear una tarea que se ejecuta en un horario cron (ej: `0 2 * * *`), selecciona una acción predefinida del sistema (ej: `sync-erp`) y la activa o desactiva.
- **Página de Configuración de Servicios (`/admin/notifications/settings`):**
    - Un formulario para guardar credenciales de servicios externos, específicamente para el bot de **Telegram** (Bot Token y Chat ID).

### 1.3. Lógica y Flujo
- **Registro de Tareas (`task-registry.ts`):** Un archivo central donde se definen las funciones que pueden ser llamadas por el cron (ej: `syncAllData`).
- **Motor de Cron (`cron-runner.ts`):** Un script que se inicia con el servidor, lee las tareas activas de la base de datos y las programa usando `node-cron`.
- **Motor de Eventos (`notifications-engine.ts`):** Una función `triggerNotificationEvent` que, al ser llamada desde cualquier parte del código, busca reglas que coincidan con el evento y ejecuta la acción correspondiente (enviar correo, telegram, etc.).
- **Nuevas Tablas en `notifications.db`:**
    - `notification_rules`: Para guardar las reglas de notificación.
    - `scheduled_tasks`: Para guardar las tareas cron.
    - `notification_settings`: Para guardar credenciales de servicios como Telegram.

---

## 2. Módulo: Centro de Despacho (FUNCIONALIDAD MAYOR)

Este es el módulo más grande y crítico a reconstruir. Digitaliza todo el proceso de alistamiento y verificación de mercadería.

### 2.1. Parte A: Configuración y Clasificación

- **Nuevas Tablas en `warehouse.db`:**
    - `dispatch_containers`: Para las rutas/contenedores (ej: "Ruta San José").
    - `dispatch_assignments`: Para asociar facturas a contenedores.
    - `dispatch_logs`: Para auditar cada verificación.
- **Ampliación de `Config. Almacenes`:** La página `/admin/warehouse` debe ser ampliada. Además de la configuración existente, se deben añadir dos nuevas secciones:
    - **Notificaciones Automáticas de Despacho:** Un campo de texto para ingresar una lista de correos que recibirán una copia del comprobante de despacho.
    - **Gestión de Contenedores de Despacho:** Una interfaz para crear y eliminar los `dispatch_containers` (rutas).
- **Página del Clasificador (`/warehouse/dispatch-classifier`):**
    - Una vista con dos pestañas: "Asignar" y "Ordenar".
    - **Pestaña "Asignar":** Filtro de fechas para buscar facturas/remisiones del ERP que no han sido asignadas. Permite selección masiva y asignación a un contenedor.
    - **Pestaña "Ordenar":** Vista de columnas (una por contenedor) que permite arrastrar y soltar (`drag-and-drop`) las facturas para definir el orden de entrega. Debe mostrar una alerta visual si una factura fue anulada.

### 2.2. Parte B: Flujo de Verificación del Bodeguero

- **Página del Centro de Despacho (`/warehouse/dispatch-center`):**
    - Muestra tarjetas para cada contenedor. Al hacer clic, se debe **bloquear** el contenedor para ese usuario, evitando que dos personas trabajen en la misma ruta.
    - Dentro, muestra la lista ordenada de documentos.
- **Página de Verificación (`/warehouse/dispatch-check`):**
    - La interfaz principal de escaneo. Muestra la lista de artículos de la factura.
    - Un `Input` para escanear códigos de barras que incrementa la cantidad del artículo correcto.
    - Al finalizar, guarda el `dispatch_log` y navega automáticamente al siguiente documento del contenedor si existe.

### 2.3. Parte C: Reporte de Despachos

- **Nueva Página (`/analytics/dispatch-report`):**
    - Este reporte **no existe** en la versión antigua y debe ser creado.
    - Debe permitir auditar todas las verificaciones, con filtros por fecha y búsqueda.
    - Debe mostrar quién verificó qué documento, cuándo, y permitir ver el detalle de los artículos con sus discrepancias.

---

## 3. Módulo: Corrección de Ingresos (Almacén)

### 3.1. Objetivo
Crear una herramienta de "cuchillo suizo" para que un supervisor pueda corregir un error común: registrar un producto con un código incorrecto durante la recepción de mercadería.

### 3.2. Requisitos
- **Nueva Página (`/warehouse/correction`):**
    - Una interfaz para **buscar** una unidad de inventario (`InventoryUnit`) por varios criterios (fecha, lote, producto, etc.).
    - Una tabla con los resultados, donde cada fila tiene un botón "Corregir".
- **Modal de Corrección:**
    - Al hacer clic en "Corregir", se abre un `Dialog`.
    - Muestra la información de la unidad original.
    - Proporciona un `SearchInput` para buscar y seleccionar el **producto correcto**.
    - Incluye una advertencia clara sobre la irreversibilidad de la acción y requiere confirmación.
- **Acción del Servidor (`correctInventoryUnit`):**
    - Debe ejecutar una transacción en `warehouse.db` que:
        1. Anula la `InventoryUnit` original (ej. cantidad a 0).
        2. Registra un movimiento de inventario de **salida** para el producto incorrecto.
        3. Crea una **nueva** `InventoryUnit` con los datos originales pero con el **ID del producto correcto**.
        4. Registra un movimiento de inventario de **entrada** para el producto correcto.
        5. Registra todo el evento en la tabla de `logs` para auditoría.

---

## 4. Consultas SQL de Referencia (Crítico)

Estas son las consultas SQL predeterminadas que la aplicación utiliza para sincronizarse con el ERP. Son esenciales para el funcionamiento de los nuevos módulos y reportes. Deben ser copiadas en **Administración > Importar Datos > Gestor de Consultas SQL**.

```sql
-- Clientes
SELECT [CLIENTE], [NOMBRE], [DIRECCION], [TELEFONO1], [CONTRIBUYENTE], [MONEDA], [LIMITE_CREDITO], [CONDICION_PAGO], [VENDEDOR], [ACTIVO], [E_MAIL], [EMAIL_DOC_ELECTRONICO] FROM [GAREND].[CLIENTE]

-- Artículos
SELECT [ARTICULO], [DESCRIPCION], [CLASIFICACION_2], [ULTIMO_INGRESO], [ACTIVO], [NOTAS], [UNIDAD_VENTA], [CANASTA_BASICA], [CODIGO_HACIENDA], [CODIGO_BARRAS_VENT] FROM [SOFTLAND].[GAREND].[ARTICULO]

-- Exoneraciones
SELECT [CODIGO], [DESCRIPCION], [CLIENTE], [NUM_AUTOR], [FECHA_RIGE], [FECHA_VENCE], [PORCENTAJE], [TIPO_DOC], [NOMBRE_INSTITUCION], [CODIGO_INSTITUCION] FROM [GAREND].[EXENCION]

-- Existencias
SELECT [ARTICULO], [BODEGA], [CANT_DISPONIBLE] FROM [GAREND].[EXISTENCIA_BODEGA]

-- Ubicaciones (si se gestionan en el ERP)
SELECT [CODIGO], [P. HORIZONTAL], [P. VERTICAL], [RACK], [CLIENTE], [DESCRIPCION] FROM [GAREND].[UBICACION]

-- Proveedores
SELECT [PROVEEDOR], [NOMBRE], [ALIAS], [E_MAIL], [TELEFONO1] FROM [GAREND].[PROVEEDOR]

-- Pedidos del ERP (Cabeceras)
-- Nota: El filtro de fecha es importante para el rendimiento.
SELECT T0.[PEDIDO], T0.[ESTADO], T0.[CLIENTE], T0.[FECHA_PEDIDO], T0.[FECHA_PROMETIDA], T0.[ORDEN_COMPRA], T0.[TOTAL_UNIDADES], T0.[MONEDA_PEDIDO], T0.[USUARIO] FROM [GAREND].[PEDIDO] AS T0 WHERE T0.[FECHA_PEDIDO] >= DATEADD(day, -60, GETDATE()) AND T0.[ESTADO] NOT IN ('F', 'C') ORDER BY T0.[FECHA_PEDIDO] DESC

-- Pedidos del ERP (Líneas)
SELECT T1.[PEDIDO], T1.[PEDIDO_LINEA], T1.[ARTICULO], T1.[CANTIDAD_PEDIDA], T1.[PRECIO_UNITARIO] FROM [GAREND].[PEDIDO_LINEA] AS T1 INNER JOIN [GAREND].[PEDIDO] AS T0 ON T1.PEDIDO = T0.PEDIDO WHERE T0.FECHA_PEDIDO >= DATEADD(day, -60, GETDATE()) AND T1.[ESTADO] NOT IN ('F', 'C')

-- Órdenes de Compra del ERP (Cabeceras)
SELECT [ORDEN_COMPRA], [PROVEEDOR], [FECHA_HORA], [ESTADO], [CreatedBy] FROM [SOFTLAND].[GAREND].[ORDEN_COMPRA]

-- Órdenes de Compra del ERP (Líneas)
SELECT [ORDEN_COMPRA], [ARTICULO], [CANTIDAD_ORDENADA] FROM [SOFTLAND].[GAREND].[ORDEN_COMPRA_LINEA]

-- Facturas del ERP (Cabeceras)
SELECT [CLIENTE], [NOMBRE_CLIENTE], [TIPO_DOCUMENTO], [FACTURA], [PEDIDO], [FACTURA_ORIGINAL], [FECHA], [FECHA_ENTREGA], [ANULADA], [EMBARCAR_A], [DIRECCION_FACTURA], [OBSERVACIONES], [RUTA], [USUARIO], [USUARIO_ANULA], [ZONA], [VENDEDOR], [REIMPRESO] FROM [SOFTLAND].[GAREND].[FACTURA]

-- Facturas del ERP (Líneas)
SELECT [FACTURA], [TIPO_DOCUMENTO], [LINEA], [BODEGA], [PEDIDO], [ARTICULO], [ANULADA], [FECHA_FACTURA], [CANTIDAD], [PRECIO_UNITARIO], [TOTAL_IMPUESTO1], [PRECIO_TOTAL], [DESCRIPCION], [DOCUMENTO_ORIGEN], [CANT_DESPACHADA], [ES_CANASTA_BASICA] FROM [SOFTLAND].[GAREND].[FACTURA_LINEA]

-- Datos de RRHH (si aplican)
SELECT [VENDEDOR], [NOMBRE], [EMPLEADO] FROM [SOFTLAND].[GAREND].[VENDEDOR]
SELECT [CLIENTE], [DIRECCION], [DETALLE_DIRECCION], [DESCRIPCION] FROM [SOFTLAND].[GAREND].[DIRECC_EMBARQUE]
SELECT [NOMINA], [DESCRIPCION], [TIPO_NOMINA] FROM [SOFTLAND].[GAREND].[NOMINA]
SELECT [PUESTO], [DESCRIPCION], [ACTIVO] FROM [SOFTLAND].[GAREND].[PUESTO]
SELECT [DEPARTAMENTO], [DESCRIPCION], [ACTIVO] FROM [SOFTLAND].[GAREND].[DEPARTAMENTO]
SELECT [EMPLEADO], [NOMBRE], [ACTIVO], [DEPARTAMENTO], [PUESTO], [NOMINA] FROM [SOFTLAND].[GAREND].[EMPLEADO]
SELECT [NUMERO_PLACA], [ENTIDAD_EMISORA] FROM [SOFTLAND].[GAREND].[VEHICULO]
```

---

## 5. Documentación de Ayuda (Copia de `help/page.tsx`)

<!-- Contenido del archivo de ayuda actualizado -->
"use client";

import { useEffect, useState, useMemo } from "react";
import { usePageTitle } from "@/modules/core/hooks/usePageTitle";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";
import {
  Code,
  FileUp,
  FileTerminal,
  Network,
  ShieldCheck,
  Users,
  Building,
  FileDown,
  PlusCircle,
  UserCog,
  DatabaseZap,
  Keyboard,
  DollarSign,
  ShieldQuestion,
  LifeBuoy,
  Rocket,
  Boxes,
  CalendarCheck,
  ShoppingCart,
  Truck,
  PackageCheck,
  Factory,
  CheckCircle,
  XCircle,
  ShieldAlert,
  Search,
  Wrench,
  Map,
  PackagePlus,
  BookMarked,
  Save,
  Copy,
  Folder,
  AlertTriangle,
  ToggleRight,
  FilePlusIcon,
  Warehouse,
  Send,
  Loader2,
  Play,
  Pause,
  History,
  Undo2,
  Info,
  BadgeInfo,
  CreditCard,
  MessageSquare,
  Trash2,
  Download,
  Briefcase,
  Store,
  ListChecks,
  Hourglass,
  Layers,
  UploadCloud,
  BarChartBig,
  Lightbulb,
  FileText,
  Calculator,
  PanelLeft,
  Mail,
  KeyRound,
  BellRing,
  Palette,
  UserCheck,
  ShoppingBag,
  QrCode,
  HelpCircle,
  ClipboardCheck,
  ClipboardList,
  Wand2,
  Lock,
  LockKeyhole,
  Split,
  FileSearch,
  RotateCcw,
} from "lucide-react";
import { Skeleton } from "@/components/ui/skeleton";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { useAuth } from "@/modules/core/hooks/useAuth";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";

// --- Helper Functions ---
const normalizeText = (text: string | null | undefined): string => {
  if (!text) return "";
  return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
};

const HighlightedText = ({
  text,
  highlight,
}: {
  text: string;
  highlight: string;
}) => {
  if (!highlight.trim()) {
    return <>{text}</>;
  }
  const normalizedHighlight = normalizeText(highlight);
  const parts = text.split(
    new RegExp(
      `(${normalizedHighlight.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
      "gi"
    )
  );

  return (
    <>
      {parts.map((part, i) =>
        normalizeText(part).toLowerCase() === normalizedHighlight ? (
          <mark key={i} className="bg-yellow-300 p-0 m-0">
            {part}
          </mark>
        ) : (
          <span key={i}>{part}</span>
        )
      )}
    </>
  );
};

const HelpSection = ({
  title,
  icon,
  content,
  searchTerm,
}: {
  title: string;
  icon: React.ReactNode;
  content: React.ReactNode;
  searchTerm: string;
}) => {
  const contentString = useMemo(() => {
    const getText = (node: React.ReactNode): string => {
      if (typeof node === "string") return node;
      if (Array.isArray(node)) return node.map(getText).join(" ");
      if (typeof node === "object" && node !== null && "props" in node && node.props.children) {
        return getText(node.props.children);
      }
      return "";
    };
    return getText(content);
  }, [content]);

  const isVisible = useMemo(() => {
    const searchTerms = normalizeText(searchTerm).split(" ").filter(Boolean);
    if (searchTerms.length === 0) return true;
    const targetText = normalizeText(title + " " + contentString);
    return searchTerms.every((term) => targetText.includes(term));
  }, [searchTerm, title, contentString]);

  if (!isVisible) return null;

  return (
    <AccordionItem value={title}>
      <AccordionTrigger className="text-lg font-semibold">
        <div className="flex items-center">
          {icon}
          <HighlightedText text={title} highlight={searchTerm} />
        </div>
      </AccordionTrigger>
      <AccordionContent className="prose max-w-none text-base">
        {content}
      </AccordionContent>
    </AccordionItem>
  );
};

export default function HelpPage() {
  const { setTitle } = usePageTitle();
  const { companyData } = useAuth();
  const [searchTerm, setSearchTerm] = useState("");

  useEffect(() => {
    setTitle("Centro de Ayuda");
  }, [setTitle]);

  const helpSections = [
    {
        title: "Introducción al Sistema",
        icon: <Rocket className="mr-4 h-6 w-6 text-blue-500" />,
        content: (
            <>
                <p>
                ¡Bienvenido a <strong><HighlightedText text={companyData?.systemName || "la Aplicación"} highlight={searchTerm}/></strong>! Piensa en este sistema como tu navaja suiza digital para las tareas diarias de la empresa. Ha sido diseñado para ser súper rápido y fácil de usar desde cualquier computadora en la oficina.
                </p>
                <p>
                El objetivo es simple: tener todas las herramientas importantes (como hacer cotizaciones, solicitudes de compra o planificar la producción) en un solo lugar, con la flexibilidad de obtener datos tanto de archivos de texto como directamente desde el ERP.
                </p>
                 <Alert variant="default" className="mt-4">
                    <AlertTriangle className="h-4 w-4" />
                    <AlertTitle>¡Nuevo Panel Lateral Plegable!</AlertTitle>
                    <AlertDescription>
                        Ahora puedes hacer clic en el botón <span className="inline-flex items-center justify-center h-6 w-6 bg-primary/10 rounded-md"><PanelLeft className="h-4 w-4 text-primary" /></span> en la esquina superior izquierda para contraer el menú lateral y maximizar tu espacio de trabajo.
                    </AlertDescription>
                </Alert>
            </>
        )
    },
    {
        title: "Guía del Centro de Notificaciones",
        icon: <BellRing className="mr-4 h-6 w-6 text-yellow-500" />,
        content: (
             <div className="space-y-4">
                <p>
                El Centro de Notificaciones es el corazón de la comunicación proactiva de la aplicación. En lugar de que tengas que revisar constantemente los módulos, el sistema te avisará cuando algo requiera tu atención.
                </p>
                
                <h4 className="font-semibold text-lg pt-2 border-t">¿Cómo Funciona?</h4>
                <ul className="list-disc space-y-3 pl-6">
                    <li>
                        <strong>Icono de Campana (<BellRing className="inline h-4 w-4"/>):</strong> Ubicado en la cabecera, este icono mostrará un punto rojo con un número que indica cuántas notificaciones tienes sin leer. Si llega una nueva, se animará sutilmente.
                    </li>
                    <li>
                        <strong>Panel de Notificaciones:</strong> Al hacer clic en la campana, se desplegará una lista con tus últimas notificaciones, ordenadas de la más reciente a la más antigua.
                    </li>
                    <li>
                        <strong>Redirección Inteligente:</strong> Cada notificación es un enlace. Al hacerle clic, te llevará directamente a la orden, solicitud o sección correspondiente.
                    </li>
                    <li>
                        <strong>Basado en Permisos:</strong> El sistema es inteligente. No recibirás notificaciones de tareas que no puedes realizar. Por ejemplo, solo los usuarios con permiso para aprobar cancelaciones recibirán esa notificación.
                    </li>
                </ul>

                <Alert variant="default" className="mt-4">
                    <AlertTriangle className="h-4 w-4" />
                    <AlertTitle>Notificaciones Accionables</AlertTitle>
                    <AlertDescription>
                        Algunas notificaciones, como las de &quot;solicitud de cancelación&quot;, incluirán botones de acción rápida (ej: &quot;Aprobar&quot;, &quot;Rechazar&quot;). Esto te permite gestionar tareas críticas directamente desde el panel de notificaciones sin tener que navegar a la página específica.
                    </AlertDescription>
                </Alert>
                 <Alert variant="default" className="mt-4">
                    <AlertTriangle className="h-4 w-4" />
                    <AlertTitle>Notificaciones de Sugerencias</AlertTitle>
                    <AlertDescription>
                        Los usuarios con el permiso `admin:suggestions:read` también recibirán una notificación cada vez que se envíe una nueva sugerencia a través del buzón del sistema, asegurando que el feedback sea atendido rápidamente.
                    </AlertDescription>
                </Alert>
            </div>
        )
    },
    {
        title: "Guía Crítica: Sincronización de Datos del ERP",
        icon: <DatabaseZap className="mr-4 h-6 w-6 text-cyan-500" />,
        content: (
            <div className="space-y-4">
                <p>
                Esta es una de las funcionalidades más importantes. Permite que la aplicación se mantenga al día con los datos maestros de tu sistema ERP (clientes, productos, inventario, etc.). Se gestiona desde <strong>Administración &gt; Importar Datos</strong> y tiene dos modos de funcionamiento.
                </p>

                <h4 className="font-semibold text-lg pt-2 border-t">Modo 1: Importación desde Archivos</h4>
                <ul className="list-disc space-y-3 pl-6">
                    <li>
                        <strong>¿Cómo funciona?:</strong> Debes generar archivos de texto plano (`.txt` o `.csv`) desde tu ERP y colocarlos en una carpeta en el servidor. Luego, en la pantalla de importación, le dices a la aplicación la ruta completa de cada archivo.
                    </li>
                    <li>
                        <strong>Ventajas:</strong> Es un método robusto y sencillo de configurar, ideal si no quieres dar acceso directo a tu base de datos del ERP.
                    </li>
                </ul>

                <h4 className="font-semibold text-lg pt-2 border-t">Modo 2: Sincronización desde SQL Server (Recomendado)</h4>
                 <ul className="list-disc space-y-3 pl-6">
                    <li>
                        <strong>¿Cómo funciona?:</strong> En lugar de archivos, la aplicación se conecta directamente a la base de datos de tu ERP (usando un usuario de **solo lectura**) y ejecuta consultas `SELECT` para traer los datos.
                    </li>
                     <li>
                        <strong>¿Cómo se configura?:</strong> Un administrador debe ir a <strong>Administración &gt; Importar Datos</strong> y:
                        <ol className="list-decimal space-y-2 pl-5 mt-2">
                            <li>Activar el interruptor a &quot;Importar desde SQL Server&quot;.</li>
                            <li>Ingresar las credenciales de la base de datos (servidor, usuario, contraseña, etc.).</li>
                            <li>Pegar las consultas `SELECT` específicas para cada tipo de dato (clientes, artículos, etc.) en el &quot;Gestor de Consultas&quot;.</li>
                        </ol>
                    </li>
                    <li>
                        <strong>Ventajas:</strong> Es más rápido, directo y elimina la necesidad de generar archivos manualmente.
                    </li>
                </ul>

                <h4 className="font-semibold text-lg pt-2 border-t">¿Qué es el Botón &quot;Sincronizar ERP&quot;?</h4>
                 <ul className="list-disc space-y-3 pl-6">
                    <li>Este botón, visible en el encabezado para usuarios con permisos, ejecuta el proceso de importación completo (ya sea desde archivos o SQL) en segundo plano.</li>
                    <li>
                        <strong>Alerta de Sincronización Antigua (<AlertTriangle className="inline h-4 w-4 text-red-600"/>):</strong> Si ha pasado mucho tiempo desde la última sincronización (el tiempo es configurable en Administración &gt; General), el indicador &quot;Última Sinc&quot; y el botón de sincronización se pondrán en **rojo y parpadearán**. Esto es una alerta visual crítica que te indica que los datos de la aplicación (como precios o inventario) pueden estar desactualizados.
                    </li>
                </ul>
            </div>
        )
    },
    {
        title: "Guía de Seguridad: Recuperación de Contraseña",
        icon: <KeyRound className="mr-4 h-6 w-6 text-fuchsia-600" />,
        content: (
            <div className="space-y-4">
                <p>
                Para mejorar la seguridad y la autonomía del usuario, el sistema ahora incluye un flujo completo para recuperar el acceso a una cuenta.
                </p>
                 <Alert variant="destructive">
                    <LockKeyhole className="h-4 w-4" />
                    <AlertTitle>¡Mejora de Seguridad Crítica Implementada!</AlertTitle>
                    <AlertDescription>
                       El sistema de autenticación ahora utiliza **cookies seguras y `httpOnly`**. Esto significa que tu sesión es gestionada por el servidor, haciendo imposible que sea manipulada desde el navegador y previniendo la suplantación de identidad.
                    </AlertDescription>
                </Alert>

                <h4 className="font-semibold text-lg pt-2 border-t">Configuración para Administradores</h4>
                <ul className="list-disc space-y-3 pl-6">
                    <li>
                        <strong>Paso 1: Configurar el SMTP.</strong> Para que el sistema pueda enviar correos, un administrador debe ir a <strong>Administración &gt; Configuración de Correo</strong>.
                    </li>
                    <li>
                        <strong>Campos Requeridos:</strong> Se deben ingresar los datos del servidor de correo de la empresa (Host, Puerto, Usuario, Contraseña y Seguridad). Estos datos se guardan de forma segura.
                    </li>
                     <li>
                        <strong>Plantilla Personalizable:</strong> En esta misma pantalla, se puede personalizar el **asunto y el cuerpo del correo** de recuperación, usando `[NOMBRE_USUARIO]` y `[CLAVE_TEMPORAL]` como placeholders.
                    </li>
                    <li>
                        <strong>Prueba de Conexión:</strong> Es crucial usar el botón **&quot;Enviar Correo de Prueba&quot;** para verificar que la configuración sea correcta.
                    </li>
                </ul>

                <h4 className="font-semibold text-lg pt-2 border-t">Flujo de Recuperación para Usuarios</h4>
                 <ul className="list-disc space-y-3 pl-6">
                    <li>
                        <strong>¿Olvidé mi contraseña?:</strong> En la pantalla de login, el usuario hace clic en el enlace, ingresa su correo y el sistema le envía una **contraseña temporal**.
                    </li>
                    <li>
                        <strong>Inicio de Sesión Forzado:</strong> Al ingresar con la contraseña temporal, la misma tarjeta de login se transforma y le pide al usuario que establezca una **nueva contraseña personal**.
                    </li>
                    <li>
                        <strong>Proceso Finalizado:</strong> Una vez que establece su nueva contraseña, se le informa que el cambio fue exitoso y se le pide que vuelva a la pantalla de login para ingresar normalmente.
                    </li>
                </ul>

                 <h4 className="font-semibold text-lg pt-2 border-t">Creación de Nuevos Usuarios</h4>
                 <ul className="list-disc space-y-3 pl-6">
                    <li>Al crear un nuevo usuario, el administrador ahora tiene una casilla: **&quot;Forzar cambio de contraseña en el próximo inicio de sesión&quot;**.</li>
                    <li>Si se marca, el nuevo usuario seguirá el mismo flujo de cambio de contraseña forzado la primera vez que ingrese, asegurando que establezca una clave personal y segura.</li>
                 </ul>
            </div>
        )
    },
    {
        title: "Tutorial: Buzón de Sugerencias",
        icon: <MessageSquare className="mr-4 h-6 w-6 text-green-600" />,
        content: (
             <div className="space-y-4">
                <p>
                Esta es una herramienta de comunicación directa para mejorar la aplicación. Todos los usuarios pueden participar.
                </p>
                <ul className="list-disc space-y-3 pl-6">
                    <li>
                        <strong>Enviar una Sugerencia:</strong> En el panel principal, haz clic en el botón verde <strong>&quot;Sugerencias y Mejoras&quot;</strong> (<MessageSquare className="inline h-4 w-4" />). Se abrirá una ventana donde podrás escribir tu idea, reportar un problema o proponer una mejora. Al enviarla, los usuarios con permiso para leer sugerencias serán notificados.
                    </li>
                    <li>
                        <strong>Gestión para Administradores:</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>Los usuarios con permiso `admin:suggestions:read` verán un contador de sugerencias no leídas en el botón de &quot;Configuración&quot; del menú lateral.</li>
                            <li>Dentro de <strong>Administración &gt; Buzón de Sugerencias</strong>, podrán ver todas las sugerencias enviadas, quién las envió y cuándo.</li>
                            <li>Las sugerencias nuevas aparecen resaltadas. Pueden marcarlas como leídas (<CheckCircle className="inline h-4 w-4 text-green-600"/>) o eliminarlas (<Trash2 className="inline h-4 w-4 text-red-600"/>).</li>
                        </ul>
                    </li>
                </ul>
            </div>
        )
    },
     {
        title: "Guía Maestra: Asistente de Costos",
        icon: <Calculator className="mr-4 h-6 w-6 text-orange-500" />,
        content: (
            <div className="space-y-4">
                <p>Esta herramienta te ayuda a calcular los precios de venta de tus productos importados, tomando en cuenta todos los costos asociados a una compra.</p>
                
                <h4 className="font-semibold text-lg pt-2 border-t">Flujo de Trabajo del Asistente</h4>
                <ol className="list-decimal space-y-4 pl-6">
                    <li>
                        <strong>Paso 1: Cargar Facturas XML (<UploadCloud className="inline h-4 w-4"/>).</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>Usa el botón &quot;Cargar Facturas XML&quot; para seleccionar una o varias facturas de compra en formato XML de Hacienda. El sistema extraerá automáticamente todos los artículos, cantidades y costos.</li>
                            <li>Verás las facturas procesadas en la tarjeta de &quot;Facturas Procesadas&quot;, indicando si la extracción fue exitosa o si hubo algún error (ej. XML malformado).</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Paso 2: Añadir Costos y Manejar Descuentos.</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>Ingresa el costo total de **Transporte** y de **Otros Costos** (como aduanas, comisiones, etc.). El sistema **prorrateará** estos costos automáticamente entre todos los artículos cargados.</li>
                            <li>**Manejo de Descuentos:** En la misma tarjeta, puedes decidir cómo tratar los descuentos de la factura: si se aplican para **reducir el costo** del producto (beneficiando al cliente final) o si se consideran como **parte de la ganancia** de la empresa.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Paso 3: Ajustar y Calcular Precios.</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>En la tabla de &quot;Artículos Extraídos&quot;, puedes editar la mayoría de los campos.</li>
                            <li><strong>Costo Unit. (s/IVA):</strong> Este es el costo real del artículo (costo de factura + costo prorrateado +/- efecto del descuento). Puedes **sobrescribirlo manually** si necesitas ajustar el costo base para un artículo específico.</li>
                            <li><strong>Imp. %:</strong> El sistema extrae el impuesto del XML, pero puedes editarlo aquí si es necesario (ej. de &quot;13&quot; a &quot;1&quot;).</li>
                            <li><strong>Margen:</strong> Introduce el margen de ganancia deseado (ej. &quot;20&quot; para un 20%).</li>
                            <li>El sistema calculará automáticamente el **P.V.P. Unitario Sugerido** y la **Ganancia por Línea** en tiempo real.</li>
                        </ul>
                    </li>
                     <li>
                        <strong>Paso 4: Guardar o Exportar.</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li><strong>Guardar Borrador (<Save className="inline h-4 w-4"/>):</strong> Si necesitas continuar más tarde, guarda tu análisis como un borrador. Podrás cargarlo desde el botón &quot;Cargar Borradores&quot;.</li>
                            <li><strong>Exportar a Excel (<FileDown className="inline h-4 w-4"/>):</strong> Cuando los precios estén listos, haz clic en este botón. Se generará un archivo **Excel (.xlsx)** con los datos exactos que ves en pantalla, ideal para análisis externos o para archivar el cálculo.</li>
                        </ul>
                    </li>
                </ol>
            </div>
        )
    },
    {
        title: "Guía Maestra: Módulo Cotizador",
        icon: <DollarSign className="mr-4 h-6 w-6 text-green-500" />,
        content: (
             <div className="space-y-4">
                <p>Esta es tu herramienta principal para crear y enviar cotizaciones profesionales a los clientes. Su diseño está optimizado para la velocidad y la precisión.</p>
                
                <h4 className="font-semibold text-lg pt-2 border-t">Flujo de Trabajo Recomendado</h4>
                <ol className="list-decimal space-y-4 pl-6">
                    <li>
                        <strong>Paso 1: Seleccionar al Cliente y Verificar su Información.</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>Empieza a escribir el nombre, código o cédula del cliente en el campo &quot;Buscar Cliente&quot;. El sistema te mostrará una lista de sugerencias. Haz clic o presiona `Enter` para seleccionarlo.</li>
                            <li>Al seleccionar, aparecerá una tarjeta con los <strong>datos críticos del ERP</strong> (<CreditCard className="inline h-4 w-4"/>): cédula, límite de crédito, condición de pago y vendedor asignado. Esto te da una visión instantánea del estado del cliente.</li>
                            <li><strong>Verificar Exoneración (<ShieldQuestion className="inline h-4 w-4" />):</strong> Si el cliente tiene una exoneración en el ERP, aparecerá una segunda tarjeta. El sistema consultará a Hacienda **en tiempo real** y te mostrará dos estados para que los compares: el del ERP y el de Hacienda. Esto te permite confirmar si la exoneración sigue vigente antes de aplicarla.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Paso 2: Agregar Productos y Consultar Detalles.</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>En el campo &quot;Agregar Producto&quot;, busca por código o descripción. El sistema te sugerirá productos y te mostrará el **inventario actual del ERP** entre paréntesis.</li>
                            <li>Presiona `Enter` o haz clic para añadir el producto a la cotización. El sistema aplicará el impuesto automáticamente (13% por defecto, 1% para canasta básica, o 0% si el cliente tiene una exoneración válida).</li>
                            <li><strong>Consultar Info del Producto (<BadgeInfo className="inline h-4 w-4"/>):</strong> Haz clic en cualquier parte de la fila de un producto ya agregado. Aparecerá una tarjeta con información detallada del ERP: su <strong>clasificación</strong>, la <strong>fecha del último ingreso</strong> y notas importantes.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Paso 3: Ajustar Cantidades y Precios.</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>Modifica directamente los campos de cantidad y precio.</li>
                            <li><strong>Atajos de Teclado (<Keyboard className="inline h-4 w-4" />):</strong> Usa la tecla `Enter` en los campos &quot;Cantidad&quot; y &quot;Precio&quot;. El sistema te moverá eficientemente: de Cantidad a Precio, y de Precio de vuelta al buscador de productos para que puedas seguir añadiendo artículos sin usar el mouse.</li>
                            <li><strong>Uso en Móviles:</strong> En pantallas pequeñas, los campos de Cantidad y Precio ahora tienen más espacio. Si necesitas ver otras columnas como &quot;Cabys&quot; o &quot;Unidad&quot;, puedes activarlas desde el botón &quot;Columnas&quot;.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Paso 4: Finalizar y Generar.</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>Ajusta las condiciones de pago, la validez de la oferta y añade cualquier nota adicional.</li>
                            <li><strong>Borradores (<Folder className="inline h-4 w-4" />):</strong> Si no terminaste, guarda la cotización como borrador. Puedes cargarla más tarde desde el botón &quot;Ver Borradores&quot;.</li>
                            <li><strong>Generar PDF (<FileDown className="inline h-4 w-4" />):</strong> Cuando todo esté listo, genera el PDF. El número de cotización se actualizará automáticamente para la próxima vez.</li>
                        </ul>
                    </li>
                </ol>
            </div>
        )
    },
    {
        title: "Guía Técnica: Módulo de Solicitudes de Compra",
        icon: <ShoppingCart className="mr-4 h-6 w-6 text-yellow-500" />,
        content: (
            <div className="space-y-4">
                <p>Esta herramienta te permite crear, gestionar y dar seguimiento a las solicitudes de compra internas de manera centralizada.</p>
                
                <h4 className="font-semibold text-lg pt-2 border-t">Flujo de Estados</h4>
                <p>Las solicitudes pasan por varios estados para un seguimiento claro:</p>
                <ul className="list-disc space-y-3 pl-6">
                    <li><strong>Pendiente:</strong> La solicitud ha sido creada y está esperando revisión.</li>
                    <li><strong>Revisión Compras:</strong> El equipo de compras está revisando la solicitud. Desde aquí, pueden **regresar a Pendiente** si se necesita una corrección.</li>
                    <li><strong>Pendiente Aprobación:</strong> La solicitud ha sido enviada para su aprobación final. Desde aquí, se puede **regresar a Revisión Compras**.</li>
                    <li><strong>Aprobada (<CheckCircle className="inline h-4 w-4 text-green-600"/>):</strong> Un usuario con permisos ha aprobado la compra.</li>
                    <li><strong>Ordenada (<Truck className="inline h-4 w-4 text-blue-600"/>):</strong> Ya se realizó el pedido al proveedor.</li>
                    <li><strong>Recibida (<PackageCheck className="inline h-4 w-4 text-teal-600"/>):</strong> (Paso opcional) El producto ha llegado. Este paso se activa en Administración.</li>
                    <li><strong>En Bodega (<Warehouse className="inline h-4 w-4 text-gray-700"/>):</strong> (Paso opcional) El producto ya está en el almacén físico.</li>
                    <li><strong>Ingresado en ERP (<DatabaseZap className="inline h-4 w-4 text-indigo-600"/>):</strong> (Paso opcional) El ingreso de la mercancía se ha registrado en el ERP.</li>
                    <li><strong>Cancelada (<XCircle className="inline h-4 w-4 text-red-600"/>):</strong> La solicitud ha sido cancelada.</li>
                </ul>

                <h4 className="font-semibold text-lg pt-2 border-t">Funcionalidades Clave</h4>
                <ul className="list-disc space-y-3 pl-6">
                <li>
                    <strong>Visibilidad por Defecto:</strong> Por seguridad y claridad, la vista de solicitudes siempre mostrará por defecto solo los documentos que tú has creado. Si tienes el permiso `requests:read:all`, la casilla &quot;Mostrar solo mis solicitudes&quot; aparecerá desmarcada por defecto, dándote visibilidad total, pero puedes marcarla para enfocarte en tus documentos.
                </li>
                <li>
                    <strong>Creación Inteligente desde ERP (<Layers className="inline h-4 w-4"/>):</strong> Permite crear solicitudes de compra automáticamente a partir de un pedido de venta del ERP. El sistema analiza el pedido, compara con el inventario actual y sugiere qué artículos comprar.
                </li>
                 <li>
                    <strong>Creación desde Sugerencias:</strong> En el módulo de Analíticas, puedes generar solicitudes directamente desde la herramienta &quot;Sugerencias de Compra&quot;. El sistema creará la solicitud con los datos disponibles y la dejará &quot;Pendiente&quot; para que Compras complete la información faltante, como el precio.
                </li>
                <li>
                    <strong>Aviso de &apos;Modificado&apos; (<AlertTriangle className="inline h-4 w-4 text-red-600" />):</strong> Si una solicitud es editada después de haber sido Aprobada u Ordenada, aparecerá una alerta visual &apos;Modificado&apos; para notificar a todos los involucrados.
                </li>
                 <li>
                    <strong>Alerta de Duplicados (<Info className="inline h-4 w-4 text-amber-500" />):</strong> Al crear una solicitud, si el sistema detecta que ya existen otras solicitudes activas (pendientes, aprobadas u ordenadas) para el mismo artículo, te mostrará una advertencia para evitar compras duplicadas.
                </li>
                 <li>
                    <strong>Tooltips Informativos:</strong> Si un botón de acción (como &quot;Aprobar&quot; o &quot;Reabrir&quot;) está desactivado, ahora puedes pasar el cursor sobre él para ver un mensaje que explica por qué no está disponible (ej: &quot;Solo para solicitudes aprobadas&quot;).
                </li>
                <li>
                    <strong>Pasos Opcionales:</strong> En <strong>Administración &gt; Config. Compras</strong>, puedes activar el paso de &quot;Recibido en Bodega&quot; y el paso final &quot;Ingresado en ERP&quot; para un control más detallado del proceso logístico.
                </li>
                <li>
                    <strong>Exportación:</strong> Puedes generar un archivo **PDF** o **Excel (.xlsx)** del reporte actual, incluyendo los filtros que hayas aplicado.
                </li>
                </ul>
            </div>
        )
    },
    {
        title: "Tutorial: Módulo Planificador OP",
        icon: <CalendarCheck className="mr-4 h-6 w-6 text-purple-500" />,
        content: (
             <div className="space-y-4">
                <p>
                Organiza y visualiza la carga de trabajo del taller o la producción. Permite un seguimiento detallado de cada orden.
                </p>
                
                <h4 className="font-semibold text-lg pt-2 border-t">Flujo de Estados Mejorado</h4>
                <p>Las órdenes pasan por varias etapas para un control preciso. Ahora puedes avanzar y retroceder en el flujo para corregir errores.</p>
                <ul className="list-disc space-y-3 pl-6">
                    <li><strong>Pendiente:</strong> La orden ha sido creada. Desde aquí, un usuario con permisos la envía al siguiente paso.</li>
                    <li><strong>Pendiente Revisión (<Send className="inline h-4 w-4 text-cyan-600"/>):</strong> La orden espera la revisión de un supervisor o encargado de producción. Desde aquí se puede **regresar a Pendiente** (<Undo2 className="inline h-4 w-4 text-orange-600"/>) si hay algo que corregir.</li>
                    <li><strong>Pendiente Aprobación (<ShoppingBag className="inline h-4 w-4 text-orange-600"/>):</strong> La orden ha sido revisada y ahora espera la aprobación final de un gerente. Desde aquí, se puede **regresar a Revisión** (<Undo2 className="inline h-4 w-4 text-orange-600"/>).</li>
                    <li><strong>Aprobada (<CheckCircle className="inline h-4 w-4 text-green-600"/>):</strong> La orden está autorizada para producción.</li>
                    <li><strong>En Cola, En Progreso, etc.:</strong> El resto del flujo continúa como antes (En Cola, En Progreso, Completada, etc.).</li>
                </ul>

                <h4 className="font-semibold text-lg pt-2 border-t">Funcionalidades Clave</h4>
                 <ul className="list-disc space-y-3 pl-6">
                    <li>
                        <strong>Visibilidad por Defecto:</strong> Al igual que en Compras, el planificador te mostrará por defecto solo las órdenes que tú has creado. Los usuarios con el permiso `planner:read:all` verán la casilla de &quot;Mostrar solo mis órdenes&quot; desmarcada al inicio para tener una vista global.
                    </li>
                    <li>
                        <strong>Validación de Campos:</strong> Al crear una nueva orden, el sistema ahora te avisará si olvidas seleccionar un cliente, un producto, o si la cantidad es cero, evitando errores.
                    </li>
                    <li>
                        <strong>Tooltips Informativos:</strong> Si un botón de acción (como &quot;Aprobar&quot; o &quot;Iniciar Progreso&quot;) está desactivado, ahora puedes pasar el cursor sobre él para ver un mensaje que explica por qué no está disponible (ej: &quot;Se requiere asignar una máquina&quot; o &quot;Solo para órdenes aprobadas&quot;).
                    </li>
                    <li>
                        <strong>Alertas y Solicitudes de Cambio:</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li><strong>Aviso de &quot;Modificado&quot; (<AlertTriangle className="inline h-4 w-4 text-red-600" />):</strong> Si una orden se edita después de ser aprobada, aparecerá esta alerta. Un supervisor deberá hacer clic en el nuevo botón <strong>&quot;Confirmar Modificación&quot;</strong> para limpiar la alerta, dejando un registro en el historial.</li>
                            <li><strong>Solicitar Desaprobación / Cancelación:</strong> Si una orden ya aprobada necesita un cambio mayor o debe ser cancelada, puedes solicitarlo. Esto notificará a los administradores para que aprueben o rechacen tu petición. Si es rechazada, recibirás una notificación de vuelta.</li>
                        </ul>
                    </li>
                    <li>
                        **Historial (<History className="inline h-4 w-4"/>):** Haz clic en el icono de historial en cualquier orden para ver un registro detallado de cada cambio de estado, quién lo hizo y cuándo.
                    </li>
                </ul>
            </div>
        )
    },
    {
        title: "Tutorial: Módulo de Analíticas",
        icon: <BarChartBig className="mr-4 h-6 w-6 text-indigo-500" />,
        content: (
            <div className="space-y-4">
                <p>
                Este es el centro de inteligencia de la aplicación. Agrupa herramientas que analizan los datos del ERP y del sistema para ayudarte a tomar decisiones más inteligentes.
                </p>
                <h4 className="font-semibold text-lg pt-2 border-t">Sugerencias de Compra Proactivas (<Lightbulb className="inline h-5 w-5 text-yellow-400"/>)</h4>
                <ol className="list-decimal space-y-3 pl-6">
                    <li>
                        <strong>¿Qué hace?:</strong> Esta herramienta revisa todos los pedidos de venta del ERP dentro de un rango de fechas, los compara con el inventario actual y te dice exactamente qué artículos te hacen falta para cumplir con esos pedidos.
                    </li>
                    <li>
                        <strong>¿Cómo se usa?:</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>Selecciona un rango de fechas de los pedidos del ERP que quieres analizar y haz clic en <strong>&quot;Analizar Pedidos&quot;</strong>.</li>
                            <li>El sistema te mostrará una tabla con los artículos faltantes. Para cada artículo, verás la cantidad total que necesitas, cuánto tienes en inventario, y el faltante exacto.</li>
                            <li>**Ordena los resultados:** Haz clic en el encabezado de cualquier columna (ej: <strong>&quot;Próxima Entrega&quot;</strong> o <strong>&quot;Faltante Total&quot;</strong>) para ordenar la tabla según ese criterio. Una flecha te indicará el orden actual.</li>
                            <li>Usa los filtros de búsqueda y de clasificación (que ahora permite **selección múltiple**) para refinar la lista.</li>
                            <li>
                                <strong>Crear Solicitudes:</strong> Marca los artículos que quieres comprar y haz clic en <strong>&quot;Crear Solicitudes&quot;</strong>. El sistema creará las solicitudes automáticamente en segundo plano, dejándolas &quot;Pendientes&quot; para que Compras complete la información faltante, como el precio.
                            </li>
                             <li>
                                <strong>Alerta de Duplicados (<Info className="inline h-4 w-4 text-amber-500"/>):</strong> Si intentas crear una solicitud para un artículo que ya tiene una solicitud activa, el sistema te mostrará una **alerta con detalles**, incluyendo el número de la solicitud existente y quién la creó. Podrás decidir si quieres crear el duplicado o no.
                            </li>
                            <li>Puedes exportar esta vista a **Excel** para un análisis más profundo.</li>
                        </ul>
                    </li>
                </ol>
                 <h4 className="font-semibold text-lg pt-2 border-t">Reporte de Permisos de Usuario (<UserCheck className="inline h-5 w-5 text-fuchsia-600"/>)</h4>
                <ol className="list-decimal space-y-3 pl-6">
                    <li>
                        <strong>¿Qué hace?:</strong> Esta es una herramienta de auditoría crucial. Te muestra una lista de todos los usuarios del sistema, su rol asignado y un desglose completo de todos los permisos que ese rol les concede.
                    </li>
                    <li>
                        <strong>¿Cómo se usa?:</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>Accede al reporte para ver la tabla completa.</li>
                            <li>Usa la barra de búsqueda para filtrar rápidamente por nombre de usuario, correo o nombre del rol.</li>
                            <li>Haz clic en los encabezados de columna <strong>&quot;Usuario&quot;</strong> o <strong>&quot;Rol&quot;</strong> para ordenar la lista.</li>
                            <li>Exporta la vista actual a **PDF** o **Excel** para compartirla o archivarla como un registro de auditoría de seguridad.</li>
                        </ul>
                    </li>
                </ol>
                 <h4 className="font-semibold text-lg pt-2 border-t">Reporte de Despachos (<Truck className="inline h-5 w-5 text-sky-600"/>)</h4>
                <ol className="list-decimal space-y-3 pl-6">
                    <li>
                        <strong>¿Qué hace?:</strong> Esta herramienta te permite auditar todas las verificaciones de despacho que se han realizado, quién las hizo, cuándo y cuáles fueron las discrepancias.
                    </li>
                    <li>
                        <strong>¿Cómo se usa?:</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>Filtra por un rango de fechas y presiona <strong>&quot;Generar Reporte&quot;</strong>.</li>
                            <li>La tabla te mostrará un resumen de cada despacho. Haz clic en <strong>&quot;Ver Detalles&quot;</strong> en cualquier fila.</li>
                            <li>Se abrirá una ventana con el desglose de cada artículo, resaltando en rojo o amarillo cualquier diferencia entre lo requerido y lo verificado.</li>
                            <li>Desde esta ventana de detalles, puedes usar el botón <strong>&quot;Reimprimir Comprobante&quot;</strong> para generar el PDF de auditoría de esa verificación específica.</li>
                        </ul>
                    </li>
                </ol>
            </div>
        )
    },
    {
        title: "Guía Maestra: Módulo de Almacenes",
        icon: <Warehouse className="mr-4 h-6 w-6 text-cyan-600" />,
        content: (
            <div className="space-y-4">
                <p>Este módulo te da control total sobre la localización y conteo de tu inventario. Incluye herramientas para mapear tu bodega, registrar conteos y generar etiquetas QR.</p>
                
                <h4 className="font-semibold text-lg pt-4 border-t">Nuevo Módulo: Centro de Despacho (<Truck className="inline h-4 w-4 text-blue-500"/>)</h4>
                 <p>Esta es la funcionalidad más importante añadida en la v2.2.0. Digitaliza el proceso de alistamiento y verificación de mercadería, reemplazando el papel.</p>
                <ol className="list-decimal space-y-3 pl-6">
                    <li>
                        <strong>Paso 1: Configurar Rutas (Admin).</strong> Un administrador debe ir a <strong>Administración &gt; Config. Almacenes</strong> y crear los "Contenedores de Despacho", que son tus rutas (ej: "Ruta San José", "Ruta Heredia").
                    </li>
                    <li>
                        <strong>Paso 2: Asignar Facturas (Logística).</strong> En <strong>Almacén &gt; Clasificador de Despachos</strong>, el personal de logística ve las facturas del ERP sin asignar. Pueden seleccionarlas y moverlas al contenedor de ruta correcto. En la pestaña "Ordenar", pueden arrastrar las facturas para definir el orden de entrega.
                    </li>
                    <li>
                        <strong>Paso 3: Verificar (Bodega).</strong> En <strong>Almacén &gt; Centro de Despacho</strong>, el bodeguero hace clic en una ruta. Esto **bloquea la ruta** para él.
                    </li>
                    <li>
                        <strong>Paso 4: Chequeo Inteligente.</strong> Al hacer clic en un documento dentro de la ruta, se abre la pantalla de verificación. El bodeguero escanea los artículos. Cuando termina, el sistema lo pasa automáticamente al siguiente documento de la lista.
                    </li>
                    <li>
                        <strong>Manejo de Errores:</strong>
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                           <li><strong>Facturas Anuladas (<AlertTriangle className="inline h-4 w-4 text-red-600"/>):</strong> Si una factura es anulada en el ERP después de ser asignada, aparecerá con una alerta visual roja y no se podrá verificar.</li>
                           <li><strong>Mover a Otra Ruta:</strong> Si una factura se asignó mal, el bodeguero puede usar el botón "Mover" para enviarla a otro contenedor.</li>
                        </ul>
                    </li>
                </ol>

                <h4 className="font-semibold text-lg pt-4 border-t">Otras Herramientas de Almacén</h4>
                 <div className="flex items-center gap-2 p-3 rounded-lg bg-blue-50 border border-blue-200 text-blue-800">
                    <HelpCircle className="h-5 w-5"/>
                    <p className="text-sm">Una vez configurado, el personal de almacén puede usar las herramientas desde el sub-panel <strong>Almacén</strong>:</p>
                </div>
                 <ul className="list-disc space-y-3 pl-6 mt-4">
                    <li>
                        <strong>Corrección de Ingresos (<RotateCcw className="inline h-4 w-4 text-red-500"/>):</strong> Si se recibió un producto con un código incorrecto, esta herramienta permite buscar esa unidad de inventario y cambiarla por el producto correcto, generando los movimientos de inventario de anulación y nuevo ingreso automáticamente.
                    </li>
                    <li>
                        <strong>Asistente de Poblado (<Wand2 className="inline h-4 w-4 text-indigo-500" />):</strong> Permite poblar masivamente las ubicaciones de un rack de forma guiada, ideal para el ingreso de mercadería nueva. Incluye un sistema para retomar sesiones interrumpidas y ahora muestra un indicador de `(Finalizado)` en los niveles que ya se completaron.
                    </li>
                    <li>
                        <strong>Asistente de Recepción (<PackageCheck className="inline h-4 w-4 text-emerald-600"/>):</strong> Registra producto terminado o compras y genera etiquetas QR para las nuevas unidades.
                    </li>
                     <li>
                        <strong>Toma de Inventario Físico (<ClipboardCheck className="inline h-4 w-4"/>):</strong> Permite a los bodegueros registrar conteos físicos de un producto en una ubicación específica. Estos datos se pueden usar luego para generar reportes y ajustar el inventario en el ERP.
                    </li>
                     <li>
                        <strong>Reporte de Inventario Físico (<ClipboardList className="inline h-4 w-4"/>):</strong> (En Analíticas) Es la contraparte de la toma de inventario. Muestra una tabla comparando la `Cantidad Contada` vs. el `Stock del ERP` y resalta las diferencias.
                    </li>
                    <li>
                        <strong>Gestión de Bloqueos (<Lock className="inline h-4 w-4"/>):</strong> Una herramienta administrativa para ver qué ubicaciones o contenedores están siendo usados y liberar bloqueos si un usuario deja una sesión abandonada.
                    </li>
                </ul>
            </div>
        )
    },
    {
        title: "Tutorial: Consultas a Hacienda",
        icon: <Search className="mr-4 h-6 w-6 text-indigo-500" />,
        content: (
            <div className="space-y-4">
                <p>
                Esta herramienta te permite consultar información directamente de las APIs del Ministerio de Hacienda de Costa Rica de forma centralizada.
                </p>
                <ul className="list-disc space-y-3 pl-6">
                    <li>
                        <strong>Búsqueda Unificada:</strong> Es la forma más potente de usar el módulo. Busca un cliente del ERP y el sistema hará todo el trabajo:
                        <ul className="list-[circle] space-y-2 pl-5 mt-2 text-sm">
                            <li>Consultará la <strong>Situación Tributaria</strong> del cliente usando su cédula.</li>
                            <li>Buscará si tiene una <strong>exoneración asociada en el ERP</strong>.</li>
                            <li>Si la encuentra, consultará esa exoneración en Hacienda para ver su <strong>estado y los códigos CABYS</strong> que cubre.</li>
                            <li>Te presentará toda la información consolidada en una sola pantalla.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Búsquedas Individuales:</strong> También puedes usar las pestañas &quot;Situación Tributaria&quot; y &quot;Exoneraciones&quot; para hacer consultas directas a Hacienda ingresando una cédula o un número de autorización, respectivamente.
                    </li>
                </ul>
            </div>
        )
    },
    {
        title: "Tutorial: Mi Perfil",
        icon: <UserCog className="mr-4 h-6 w-6 text-blue-500" />,
        content: (
            <div className="flex items-start gap-4">
                <UserCog className="mt-1 h-6 w-6 text-blue-500 shrink-0" />
                <div>
                    <p>
                    Aquí puedes personalizar tu propia cuenta de usuario.
                    </p>
                    <ul className="list-disc space-y-2 pl-6">
                        <li>Actualiza tu nombre, teléfono y WhatsApp.</li>
                        <li>Cambia tu foto de perfil haciendo clic sobre el círculo con tus iniciales.</li>
                        <li>Cambia tu contraseña.</li>
                        <li>Configura una pregunta de seguridad para poder recuperar tu cuenta si olvidas la contraseña.</li>
                    </ul>
                </div>
            </div>
        )
    },
    {
        title: "Guía Técnica: Panel de Administración (Configuración)",
        icon: <Wrench className="mr-4 h-6 w-6 text-slate-600" />,
        content: (
            <div className="space-y-4">
                <p>
                Esta es la sala de máquinas del sistema, accesible solo para administradores. Aquí se configura todo el comportamiento de la aplicación, módulo por módulo.
                </p>
                <div className="space-y-4">
                    <div className="flex items-start gap-4">
                        <Users className="mt-1 h-6 w-6 text-blue-500 shrink-0" />
                        <div><h4 className="font-semibold">Gestión de Usuarios</h4><p>Permite crear, editar, eliminar y asignar roles a las cuentas de usuario. Incluye la opción de forzar el cambio de contraseña para nuevos usuarios.</p></div>
                    </div>
                    <div className="flex items-start gap-4">
                        <ShieldCheck className="mt-1 h-6 w-6 text-green-500 shrink-0" />
                        <div><h4 className="font-semibold">Gestión de Roles</h4><p>Define qué puede hacer cada usuario. Puedes crear roles personalizados (ej: &quot;Supervisor&quot;) y asignar permisos granulares para cada módulo.</p></div>
                    </div>
                     <div className="flex items-start gap-4">
                        <BellRing className="mt-1 h-6 w-6 text-yellow-500 shrink-0" />
                        <div><h4 className="font-semibold">Gestor de Automatización</h4><p>Define reglas de notificación automática (ej: enviar un correo cuando un despacho se completa) y tareas programadas (ej: sincronizar el ERP todas las noches).</p></div>
                    </div>
                    <div className="flex items-start gap-4">
                        <Mail className="mt-1 h-6 w-6 text-purple-600 shrink-0" />
                        <div><h4 className="font-semibold">Configuración de Correo</h4><p>Configura tu servidor de correo (SMTP) para habilitar el envío de notificaciones y la recuperación de contraseñas. Permite personalizar las plantillas de los correos.</p></div>
                    </div>
                    <div className="flex items-start gap-4">
                        <Briefcase className="mt-1 h-6 w-6 text-orange-500 shrink-0" />
                        <div><h4 className="font-semibold">Configuración General</h4><p>Establece la identidad de tu empresa (nombre, logo, etc.) y ajusta parámetros globales como el tiempo de espera de la búsqueda o las horas para la alerta de sincronización.</p></div>
                    </div>
                    <div className="flex items-start gap-4">
                        <MessageSquare className="mt-1 h-6 w-6 text-green-600 shrink-0" />
                        <div><h4 className="font-semibold">Buzón de Sugerencias</h4><p>Revisa el feedback enviado por los usuarios a través del botón &quot;Sugerencias y Mejoras&quot;.</p></div>
                    </div>
                    <div className="flex items-start gap-4">
                        <DollarSign className="mt-1 h-6 w-6 text-emerald-600 shrink-0" />
                        <div><h4 className="font-semibold">Config. Cotizador</h4><p>Ajusta el comportamiento del Cotizador, definiendo el prefijo y el número con el que iniciará la siguiente cotización.</p></div>
                    </div>
                    <div className="flex items-start gap-4">
                        <Calculator className="mt-1 h-6 w-6 text-orange-600 shrink-0" />
                        <div><h4 className="font-semibold">Config. Asist. Costos</h4><p>Gestionar ajustes para el asistente de costos.</p></div>
                    </div>
                    <div className="flex items-start gap-4">
                        <Factory className="mt-1 h-6 w-6 text-purple-700 shrink-0" />
                        <div><h4 className="font-semibold">Config. Planificador</h4><p>Personaliza el Planificador, incluyendo los nombres de &quot;máquinas&quot;, los turnos de trabajo y las columnas a exportar en PDF.</p></div>
                    </div>
                    <div className="flex items-start gap-4">
                        <Store className="mt-1 h-6 w-6 text-amber-700 shrink-0" />
                        <div><h4 className="font-semibold">Config. Compras</h4><p>Define las rutas de entrega, métodos de envío y activa pasos opcionales en el flujo de aprobación como &quot;Recibido en Bodega&quot; o &quot;Ingresado en ERP&quot;.</p></div>
                    </div>
                    <div className="flex items-start gap-4">
                        <Map className="mt-1 h-6 w-6 text-teal-700 shrink-0" />
                        <div><h4 className="font-semibold">Config. Almacenes e Inventario</h4><p>Define la jerarquía de ubicaciones, gestiona las bodegas del ERP, ajusta los prefijos para las etiquetas de unidades de inventario y configura las notificaciones de despacho.</p></div>
                    </div>
                    <div className="flex items-start gap-4">
                        <FileUp className="mt-1 h-6 w-6 text-cyan-500 shrink-0" />
                        <div>
                            <h4 className="font-semibold">Importar Datos</h4>
                            <p>Sincroniza los datos maestros (clientes, productos, etc.) desde tu ERP. Tienes dos modos: por <strong>Archivos</strong> (cargando .txt o .csv) o por <strong>SQL Server</strong> (conectando directamente a la base de datos de tu ERP).</p>
                        </div>
                    </div>
                    <div className="flex items-start gap-4">
                        <DatabaseZap className="mt-1 h-6 w-6 text-red-500 shrink-0" />
                        <div><h4 className="font-semibold">Mantenimiento</h4>
                            <p>Herramientas críticas, ahora separadas en secciones para mayor claridad y seguridad:</p>
                            <ul className="list-disc pl-5 text-sm space-y-1 mt-2">
                                <li><strong>Centro de Verificación:</strong> Audita la integridad y estructura de todas las bases de datos para asegurar que las tablas y columnas sean correctas, una herramienta vital después de una actualización.</li>
                                <li><strong>Backups y Puntos de Restauración:</strong> Gestiona backups de **todo el sistema**. Crea un &quot;Punto de Restauración&quot; antes de una actualización y restáuralo si algo sale mal.</li>
                                <li><strong>Zona de Peligro:</strong> Acciones que afectan módulos **individuales**. Aquí puedes restaurar la base de datos de un solo módulo (ej: `planner.db`) desde un archivo que subas, o resetear un módulo a su estado de fábrica. Estas acciones requieren confirmación estricta para evitar accidentes.</li>
                            </ul>
                        </div>
                    </div>
                    <div className="flex items-start gap-4">
                        <Network className="mt-1 h-6 w-6 text-indigo-500 shrink-0" />
                        <div><h4 className="font-semibold">Configuración de API</h4><p>Define las URLs de los servicios externos que utiliza la aplicación, como las APIs de Hacienda para consultar el tipo de cambio, la situación tributaria y el estado de las exoneraciones.</p></div>
                    </div>
                    <div className="flex items-start gap-4">
                        <FileTerminal className="mt-1 h-6 w-6 text-slate-500 shrink-0" />
                        <div><h4 className="font-semibold">Visor de Eventos</h4>
                            <p>Un registro (log) de todo lo que sucede en el sistema. Es una herramienta invaluable para diagnosticar problemas. Permite filtrar y limpiar los registros de forma granular (Operativos vs. Sistema) y conserva por defecto los últimos 30 días, a menos que se indique lo contrario.</p>
                        </div>
                    </div>
                </div>
            </div>
        )
    },
    {
        title: "Guía Técnica: Actualización y Problemas Comunes",
        icon: <Wrench className="mr-4 h-6 w-6 text-slate-600" />,
        content: (
            <div className="space-y-4">
                 <h4 className="font-semibold text-lg">Proceso de Actualización Seguro</h4>
                <ol className="list-decimal space-y-3 pl-6">
                    <li>
                        <strong>Paso 1: Realizar una Copia de Seguridad (<Copy className="inline h-4 w-4"/>).</strong> Este es el paso más importante. Antes de tocar nada, ve a <strong>Administración &gt; Mantenimiento</strong> y haz clic en <strong>&quot;Crear Punto de Restauración&quot;</strong>. Esto generará una copia segura de todas las bases de datos del sistema.
                    </li>
                    <li>
                        <strong>Paso 2: Reemplazar Archivos.</strong> Detén la aplicación (por ejemplo, usando `pm2 stop clic-tools` en Linux o deteniendo el sitio en IIS). Luego, borra todos los archivos y carpetas de la versión anterior **excepto** la carpeta `dbs/` y, si existe, el archivo `.env.local`. Después, copia todos los archivos de la nueva versión en su lugar.
                    </li>
                    <li>
                        <strong>Paso 3: Actualizar y Reconstruir.</strong> Abre una terminal en la carpeta del proyecto, ejecuta `npm install --omit=dev` para instalar cualquier nueva dependencia y luego `npm run build` para compilar la nueva versión.
                    </li>
                    <li>
                        <strong>Paso 4: Reiniciar y Verificar.</strong> Vuelve a iniciar la aplicación (ej: `pm2 start clic-tools`). Al arrancar, el sistema detectará las diferencias y añadirá las nuevas tablas o columnas automáticamente. Luego, ve a <strong>Administración &gt; Mantenimiento &gt; Centro de Verificación</strong> y ejecuta la auditoría para confirmar que todas las bases de datos tienen la estructura correcta.
                    </li>
                </ol>
                <Alert variant="destructive">
                    <AlertTriangle className="h-4 w-4" />
                    <AlertTitle>¡Atención!</AlertTitle>
                    <AlertDescription>
                        Nunca reemplaces la carpeta &quot;dbs/&quot; del servidor con la de la nueva versión, ya que esto borraría todos tus datos de producción.
                    </AlertDescription>
                </Alert>

                <h4 className="font-semibold text-lg pt-4 border-t">Solución de Problemas: Despliegue en IIS</h4>
                <div className="space-y-2">
                    <p><strong>Síntoma:</strong> Después de guardar un cambio en la configuración o importar datos, la aplicación se reinicia o muestra un error &quot;aborted&quot;.</p>
                    <p><strong>Diagnóstico:</strong> El vigilante de archivos de `iisnode` está detectando cambios en las bases de datos (`.db`) y reinicia la aplicación de forma incorrecta.</p>
                    <p><strong>La Solución Definitiva (v2.0.0+):</strong> A partir de la versión 2.0.0, el proyecto incluye un archivo `web.config` en la raíz. Este archivo ya está configurado para decirle a IIS que **ignore** los cambios en la carpeta &quot;dbs/&quot;, solucionando el problema de raíz. Simplemente asegúrate de que este archivo se copie al servidor durante el despliegue.</p>
                </div>
            </div>
        )
    },
     {
        title: "Control de Cambios (Changelog)",
        icon: <ListChecks className="mr-4 h-6 w-6 text-fuchsia-600" />,
        content: (
             <div className="space-y-4">
                <p>Para ver un historial detallado de todos los cambios, mejoras y correcciones de errores en cada versión, por favor consulta el archivo `CHANGELOG.md` en la raíz del proyecto. Este archivo es la fuente de verdad sobre la evolución de la aplicación.</p>
            </div>
        )
    }
  ];

  return (
    <main className="flex-1 p-4 md:p-6 lg:p-8">
      <div className="space-y-6">
        <Card>
          <CardHeader>
            <div className="flex items-center gap-4">
              <div className="flex h-12 w-12 items-center justify-center rounded-lg bg-primary text-white">
                <LifeBuoy className="h-6 w-6" />
              </div>
              <div>
                {companyData ? (
                  <CardTitle className="text-2xl">
                    Manual de Usuario de {companyData.systemName || "la Aplicación"}
                  </CardTitle>
                ) : (
                  <Skeleton className="h-8 w-96" />
                )}
                <CardDescription>
                  Guía completa sobre cómo utilizar las herramientas y funcionalidades del sistema.
                </CardDescription>
              </div>
            </div>
            <div className="relative mt-6">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground" />
              <Input
                placeholder="Escribe para buscar en la ayuda (ej: 'contraseña', 'importar', 'resetear')..."
                className="w-full pl-10 h-12 text-base"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />
            </div>
          </CardHeader>
          <CardContent>
            <Accordion type="multiple" className="w-full">
              {helpSections.map((section, index) => (
                <HelpSection
                  key={index}
                  title={section.title}
                  icon={section.icon}
                  content={section.content}
                  searchTerm={searchTerm}
                />
              ))}
            </Accordion>
          </CardContent>
        </Card>
      </div>
    </main>
  );
}

---

## 6. Historial de Cambios (Copia de `CHANGELOG.md`)

# Historial de Cambios (Changelog) - Clic-Tools

Este documento registra todas las mejoras, correcciones y cambios significativos en cada versión de la aplicación.

---

## Proceso de Actualización y Rollback

**Para actualizar a una nueva versión, siga estos pasos:**

1.  **¡Crítico! Crear Punto de Restauración:** Antes de cualquier cambio, vaya a **Administración > Mantenimiento** y haga clic en **"Crear Punto de Restauración"**. Esto crea una copia de seguridad completa de todas las bases de datos (`.db`).
2.  **Reemplazar Archivos:** Reemplace todos los archivos y carpetas de la aplicación en el servidor con los de la nueva versión, **excepto** la carpeta `dbs/` y el archivo `.env.local`.
3.  **Actualizar Dependencias:** Ejecute `npm install --omit=dev` en el servidor.
4.  **Reconstruir y Reiniciar:** Ejecute `npm run build` y reinicie la aplicación (ej: `pm2 restart clic-tools`).
5.  **Verificar:** Ejecute la auditoría desde **Administración > Mantenimiento** para confirmar que la estructura de la base de datos es correcta. Este paso es especialmente importante en la v2.2.0 para asegurar la creación de las nuevas tablas de despacho.

**Para realizar un rollback (regresar a la versión anterior):**

1.  **Restaurar Punto de Restauración:** Vaya a **Administración > Mantenimiento**, seleccione el punto de restauración que creó antes de la actualización y haga clic en "Restaurar". **Esto requiere un reinicio manual del servidor de la aplicación después de la restauración.**
2.  **Revertir Archivos:** Reemplace los archivos del servidor con los de la versión anterior.
3.  **Reinstalar y Reconstruir:** Ejecute `npm install --omit=dev` y `npm run build`.
4.  **Reiniciar:** Inicie la aplicación nuevamente.

---

## [2.2.0] - Publicado

### Nueva Funcionalidad Mayor: Centro de Despacho

Se ha implementado un nuevo módulo completo para digitalizar y optimizar el proceso de alistamiento y verificación de despachos, reemplazando el flujo de trabajo manual basado en papel.

-   **[Nuevo] Contenedores de Ruta:**
    -   Desde **Almacén > Configuración**, los administradores de logística ahora pueden crear "contenedores" que representan las rutas de entrega (ej: "Ruta San José", "Ruta Alajuela").

-   **[Nuevo] Clasificador de Despachos:**
    -   Una nueva herramienta en **Almacén > Clasificador de Despachos** permite al personal de logística ver todas las facturas y pedidos del ERP que no han sido asignados.
    -   Los usuarios pueden seleccionar múltiples documentos y asignarlos de forma masiva a un contenedor de ruta específico.
    -   Dentro de cada contenedor, es posible reordenar las facturas (arrastrando y soltando) para definir el orden de carga y entrega del camión.

-   **[Nuevo] Flujo de Chequeo para Bodegueros:**
    -   En la nueva herramienta **Almacén > Centro de Despacho**, el personal de bodega ve los contenedores de ruta.
    -   Al seleccionar un contenedor, este se **bloquea** para ese usuario, evitando que dos personas trabajen en la misma ruta simultáneamente (similar al bloqueo del Asistente de Poblado).
    -   Dentro del contenedor, se muestra la lista de facturas en el orden de entrega. Al seleccionar una, se abre la interfaz de verificación de artículos.

-   **[Mejora] Verificación de Artículos Inteligente:**
    -   La herramienta de chequeo ahora es consciente del contexto de la ruta y avanza automáticamente a la siguiente factura de la lista una vez que se completa la actual.
    -   **Manejo de Múltiples Bodegas:** Si una factura contiene artículos de diferentes bodegas, el sistema permitirá verificar solo los artículos de una bodega a la vez (próximamente se implementará la selección de bodega).
    -   El bodeguero ahora tiene un botón para **"Enviar a otra ruta"**, permitiendo mover una factura a un contenedor diferente si fue asignada por error.

-   **[Seguridad y Auditoría] Detección de Facturas Anuladas:**
    -   El sistema ahora compara continuamente los datos del ERP. Si una factura que ya fue asignada a una ruta es posteriormente **anulada en el ERP**, aparecerá con una alerta visual de "ANULADA" en la lista de chequeo, impidiendo su despacho por error.

-   **[Nuevo] Reporte de Despachos:**
    -   Ubicado en **Analíticas**, este reporte permite auditar todas las verificaciones realizadas, ver quién verificó qué documento, cuándo, y si hubo discrepancias.

### Mejoras y Correcciones Generales

-   **[Estabilidad] Notificaciones Automáticas:** Se corrigió un error crítico que impedía que el motor de notificaciones configurables enviara correos correctamente, asegurando que las alertas de eventos (como despachos finalizados, órdenes aprobadas, etc.) funcionen como se espera.
-   **[Calidad de Código] Mantenimiento de Dependencias:** Se actualizaron varias dependencias internas para mejorar la estabilidad y el rendimiento general de la aplicación.
-   **[UI] Mejoras de Accesibilidad:** Se añadieron descripciones a varios diálogos modales en toda la aplicación para mejorar la compatibilidad con lectores de pantalla y eliminar advertencias en la consola de desarrollo.
-   **[Estabilidad] Filtros de Fecha:** Se solucionó un bug persistente en los reportes donde el filtro de fecha no se aplicaba correctamente al seleccionar un solo día. Ahora los rangos de fechas funcionan de manera precisa e intuitiva.

---

## [2.1.0] - Publicado

### Mejoras de Calidad y Estabilidad

-   **[Estabilidad] Corrección de Errores de Compilación:** Se solucionaron múltiples errores de `Cannot find module` que impedían que la aplicación se compilara correctamente. La causa raíz, relacionada con la carga inicial de la página y la detección de usuarios, ha sido resuelta para garantizar builds estables.
-   **[Calidad de Código] Centralización de Lógica Duplicada:**
    -   Se unificó la lógica para determinar si un usuario es "Administrador", utilizando el sistema de permisos (`hasPermission('admin:access')`) en lugar de comprobaciones directas, lo que hace el código más mantenible.
    -   Se eliminaron funciones duplicadas para obtener las iniciales de los usuarios, centralizando la lógica en un solo lugar.
-   **[UX] Optimización del Flujo de Escáner:** En la pantalla de **Búsqueda Rápida de Almacén**, después de que un escáner introduce un código y presiona "Enter", el campo de búsqueda ahora se limpia y se re-enfoca automáticamente, permitiendo un flujo de escaneo continuo y sin interrupciones.
-   **[UI] Corrección de Etiquetas de Almacén:** Se solucionó un problema en la generación de etiquetas PDF donde las rutas de ubicación largas se cortaban. Ahora, el texto se ajusta automáticamente en varias líneas para asegurar que la información siempre sea legible.

### Mejoras de Seguridad Críticas

-   **[Seguridad] Fortalecimiento del Sistema de Autenticación:**
    -   Se reemplazará el almacenamiento del ID de usuario en `sessionStorage` (inseguro y manipulable desde el navegador) por un sistema de **cookies seguras `httpOnly`**.
    -   Esto previene que un usuario pueda suplantar la identidad de otro (ej. un administrador) modificando variables en el navegador. La sesión ahora será gestionada de forma segura por el servidor.
-   **[Seguridad] Protección de Rutas de Descarga:**
    -   Se añadió una capa de autenticación y autorización a las rutas de descarga de archivos (`/api/temp-backups` y `/api/temp-exports`).
    -   A partir de ahora, solo los usuarios autenticados con los permisos adecuados (ej. `admin:maintenance:backup`) podrán descargar respaldos de bases de datos o reportes de Excel, previniendo fugas de información.

### Mejoras y Correcciones en Módulo de Almacén

-   **Asistente de Poblado de Racks (Funcionalidad Clave):**
    -   **[Nuevo] Capacidad de Retomar Sesiones:** Se ha implementado un sistema de "sesiones" robusto. Si un usuario inicia el asistente de poblado y luego navega a otro módulo, cierra la pestaña o su sesión expira, al volver a la herramienta podrá **continuar exactamente donde se quedó**.
    -   **[Solucionado] Error de Bloqueo por Sí Mismo:** Se solucionó el bug crítico que impedía a un usuario volver a usar el asistente si lo había abandonado sin finalizar, mostrándole que él mismo tenía el tramo bloqueado.
    -   **[Mejora] Detección Visual de Bloqueos:** La interfaz ahora detecta y deshabilita visualmente los niveles de un rack que ya están siendo poblados por otro usuario, previniendo errores y mejorando la claridad.
    -   **[Mejora] Indicador de Nivel Finalizado:** En el asistente, los niveles que ya han sido completamente poblados ahora muestran una etiqueta `(Finalizado)` para dar una retroalimentación visual clara al operario.
    -   **[Solucionado] Corrección del "Unknown" en Gestión de Bloqueos:** Se solucionó el error que causaba que el nombre del tramo bloqueado apareciera como "unknown".
    -   **[Estabilidad]** Se corrigieron múltiples errores de `NOT NULL constraint failed` y `Cannot read properties of undefined` que ocurrían debido a inconsistencias en la gestión del estado de la sesión, haciendo el asistente mucho más estable.

-   **Optimización para Dispositivos Móviles (Responsivo):**
    -   **[Mejora] Consulta de Almacén:** La página principal de búsqueda (`/warehouse/search`) fue rediseñada para una mejor experiencia en celulares y tablets. La barra de búsqueda ahora es fija en la parte superior, y los filtros adicionales se han movido a un panel lateral desplegable para una interfaz más limpia.
    -   **[Mejora] Gestión de Ubicaciones:** Se ajustó la disposición de los botones en pantallas pequeñas para un acceso más fácil y rápido.
    -   **[Mejora] Consistencia General:** Se aplicaron ajustes menores de diseño en todas las herramientas del módulo de Almacén para una experiencia más unificada.

### Correcciones Generales del Sistema

-   **[Estabilidad] Corrección de Errores de Renderizado en Servidor:** Se solucionó un error general (`Cannot read properties of undefined (reading 'call')`) que ocurría en varios módulos al no especificar correctamente que eran "componentes de cliente". Se añadió la directiva `"use client";` en todas las páginas afectadas, estabilizando la aplicación.

---

## [2.0.0] - Lanzamiento Inicial

-   Lanzamiento de la versión 2.0.0 de Clic-Tools.
-   Incluye los módulos de Cotizador, Planificador OP, Solicitudes de Compra, Asistente de Costos, Almacenes, Consultas Hacienda y el panel de Administración completo.
-   Arquitectura basada en Next.js App Router, componentes de servidor y bases de datos modulares SQLite.