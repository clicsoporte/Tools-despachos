# Propuesta de Evolución: Integración de Código de Barras y Módulo de Chequeo de Despacho

Este documento detalla el plan estratégico para integrar la funcionalidad de código de barras en toda la aplicación y sentar las bases para un futuro módulo de validación de despachos.

## 1. Visión y Objetivos

### Objetivo Principal: Búsqueda por Código de Barras
- **Problema:** Actualmente, la búsqueda de productos se limita al código de artículo y la descripción. Esto es lento para el personal de bodega que maneja físicamente los productos.
- **Solución:** Integrar el campo `CODIGO_BARRAS_VENT` del ERP en la aplicación, permitiendo que cualquier campo de búsqueda de productos acepte la entrada de un escáner de código de barras para una identificación instantánea.

### Visión a Futuro: Módulo de "Chequeo de Despacho"
- **Problema:** El proceso de verificación de artículos para un despacho se realiza manualmente con una factura impresa, lo cual es lento, propenso a errores costosos (envío de producto incorrecto) y carece de trazabilidad.
- **Solución Propuesta:** Crear un módulo donde un operario escanea un número de factura, la app muestra los artículos y cantidades, y el operario valida cada artículo escaneando su código de barras, previniendo errores en tiempo real y dejando un registro de auditoría digital.

## 2. Análisis y Propuesta de Implementación

La estrategia recomendada es una **implementación por fases**, que nos permite entregar valor de forma inmediata (búsqueda por código de barras) mientras preparamos de forma segura y robusta el terreno para el futuro módulo de despachos.

### Fase 1: Cimientos de Datos (Implementación Inmediata)

Esta fase se centra en expandir el modelo de datos de la aplicación para que reconozca tanto los códigos de barras como la estructura de una factura del ERP.

1.  **Modificar Modelo de Datos (`types/index.ts`):**
    *   Añadir el campo opcional `barcode?: string;` al tipo `Product`.
    *   Crear los nuevos tipos `ErpInvoiceHeader` y `ErpInvoiceLine` para modelar los datos de las facturas que se importarán.

2.  **Actualizar Base de Datos (`lib/db.ts` y `lib/schema.ts`):**
    *   Añadir una nueva columna `barcode TEXT` a la tabla `products` en la base de datos principal (`intratool.db`).
    *   Crear una migración en `db.ts` para ejecutar el `ALTER TABLE` de forma segura.
    *   **NUEVO:** Añadir las tablas `erp_invoice_headers` y `erp_invoice_lines` al esquema de la base de datos principal y a la migración.

3.  **Actualizar Lógica de Importación (`admin/import/page.tsx` y `lib/db.ts`):**
    *   En la sección de "Gestión de Consultas SQL", actualizar la consulta por defecto para "Artículos" para que incluya el campo `CODIGO_BARRAS_VENT`.
    *   **NUEVO:** Añadir una nueva sección en el "Gestor de Consultas" para que el administrador pueda configurar las consultas `SELECT` para las cabeceras y líneas de factura del ERP.
    *   Crear las funciones `saveAllErpInvoiceHeaders` y `saveAllErpInvoiceLines` en `db.ts` para manejar la inserción de estos nuevos datos y actualizar la función de importación global para que las ejecute.

4.  **Integrar Búsqueda por Código de Barras en la UI:**
    *   **Hooks de Módulos (`useQuoter.ts`, `usePlanner.ts`, etc.):** Modificar la lógica de búsqueda en los `useMemo` de `productOptions` para que el filtro considere `product.id`, `product.description` y el nuevo `product.barcode`.
    *   **Páginas de Almacén (`warehouse/search/page.tsx`, `warehouse/search/simple/page.tsx`):** Actualizar las tarjetas de resultados para mostrar el código de barras, proporcionando una confirmación visual al usuario.

**Resultado de la Fase 1:** La búsqueda por código de barras estará 100% funcional en toda la aplicación. Los datos de las facturas se estarán sincronizando y guardando en segundo plano, listos para la siguiente fase.

### Fase 2: Módulo de Chequeo de Despacho (Implementación Futura)

Una vez completada la Fase 1, la implementación de este módulo será significativamente más sencilla.

1.  **Crear Nueva Página y Herramienta:**
    *   Añadir una nueva tarjeta de herramienta en "Almacén" llamada "Chequeo de Despacho".
    *   Crear la nueva ruta `/dashboard/warehouse/dispatch-check`.

2.  **Desarrollar la Lógica del Componente:**
    *   Crear un nuevo hook (`useDispatchCheck.ts`) que maneje el estado de la página.
    *   El componente permitirá ingresar un número de factura, que se usará para consultar las tablas `erp_invoice_headers` y `erp_invoice_lines` (ya pobladas gracias a la Fase 1).
    *   La UI mostrará la lista de artículos y manejará la lógica de escaneo y comparación, actualizando el estado de cada línea (verificado, incorrecto, faltante).

3.  **Añadir Auditoría:**
    *   Crear una nueva tabla (ej. `dispatch_logs`) en la base de datos de almacén (`warehouse.db`) para guardar un registro de cada verificación (qué factura, qué usuario, a qué hora, y si hubo discrepancias).

Este enfoque por fases mitiga el riesgo, divide el trabajo en partes lógicas y manejables, y nos permite entregar valor de forma incremental.