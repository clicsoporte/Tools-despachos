-- =================================================================================
-- CONSULTA SQL PARA REPORTE DE FALTANTES (COMPRAS PROACTIVAS)
-- =================================================================================
--
-- PROPÓSITO:
-- Esta consulta está diseñada para identificar los artículos que tienen un faltante de
-- inventario basado en la demanda de los pedidos de venta que están activos en el ERP.
--
-- LÓGICA:
-- 1.  SUMA todas las cantidades pedidas para cada artículo en los pedidos que no están
--     facturados ('F') ni cancelados ('C').
-- 2.  OBTIENE el inventario total disponible para cada uno de esos artículos.
-- 3.  COMPARA la cantidad total requerida con el inventario disponible.
-- 4.  MUESTRA únicamente los artículos donde la cantidad requerida es MAYOR que el
--     inventario disponible, calculando el "Faltante".
--
-- CÓMO USAR:
-- Puedes copiar y pegar esta consulta en el gestor de consultas de tu ERP o en
-- la herramienta de configuración de importación de Clic-Tools para crear un
-- reporte de sugerencias de compra.

WITH
  -- Paso 1: Calcular la demanda total de cada artículo desde los pedidos activos.
  Demanda AS (
    SELECT
      L.ARTICULO,
      SUM(L.CANTIDAD_PEDIDA) AS CantidadRequerida
    FROM
      GAREND.PEDIDO_LINEA AS L
      INNER JOIN GAREND.PEDIDO AS H ON L.PEDIDO = H.PEDIDO
    WHERE
      H.ESTADO NOT IN ('F', 'C') -- Filtra solo pedidos activos (no Facturados ni Cancelados)
    GROUP BY
      L.ARTICULO
  ),
  -- Paso 2: Calcular el inventario total disponible para cada artículo.
  Inventario AS (
    SELECT
      ARTICULO,
      SUM(CANT_DISPONIBLE) AS InventarioTotal
    FROM
      GAREND.EXISTENCIA_BODEGA
    GROUP BY
      ARTICULO
  )
-- Paso 3: Unir la demanda con el inventario y calcular el faltante.
SELECT
  D.ARTICULO,
  A.DESCRIPCION,
  D.CantidadRequerida,
  ISNULL(I.InventarioTotal, 0) AS InventarioTotal, -- Usa ISNULL para manejar artículos sin registro de inventario.
  (
    D.CantidadRequerida - ISNULL(I.InventarioTotal, 0)
  ) AS Faltante
FROM
  Demanda AS D
  LEFT JOIN Inventario AS I ON D.ARTICULO = I.ARTICULO
  LEFT JOIN GAREND.ARTICULO AS A ON D.ARTICULO = A.ARTICULO
WHERE
  (
    D.CantidadRequerida - ISNULL(I.InventarioTotal, 0)
  ) > 0 -- Muestra solo los artículos donde la cantidad requerida es mayor al inventario.
ORDER BY
  Faltante DESC; -- Ordena para mostrar primero los artículos con mayor faltante.
