<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <handlers>
      <!-- Indica que iisnode debe manejar las solicitudes a través del server.js de Next.js -->
      <add name="iisnode" path=".next/standalone/server.js" verb="*" modules="iisnode" />
    </handlers>

    <rewrite>
      <rules>
        <!-- Regla para servir archivos estáticos directamente desde IIS para un mejor rendimiento -->
        <rule name="StaticContent">
          <action type="Rewrite" url="public{REQUEST_URI}" />
        </rule>

        <!-- Regla principal que envía todas las demás solicitudes a Next.js a través de iisnode -->
        <rule name="NextJs">
          <match url="/*" />
          <action type="Rewrite" url=".next/standalone/server.js" />
        </rule>
      </rules>
    </rewrite>

    <!-- 
      Configuración CRÍTICA para iisnode:
      - loggingEnabled: Habilita los logs de iisnode para depuración.
      - watchedFiles: Especifica qué archivos vigilar. No incluimos la carpeta `dbs`.
      - devErrorsEnabled: Muestra errores detallados en el navegador (solo para desarrollo).
      - nodeProcessCommandLine: Asegura que se use la versión correcta de Node.js.
    -->
    <iisnode 
      loggingEnabled="true"
      watchedFiles="web.config;*.js"
      devErrorsEnabled="true"
      nodeProcessCommandLine="&quot;%programfiles%\nodejs\node.exe&quot;"
    />

    <!--
      OTRA CONFIGURACIÓN CRÍTICA:
      Desactiva el reciclaje del AppPool cuando el contenido de la subcarpeta `dbs` cambie.
      Esto previene el error "aborted".
    -->
    <applicationInitialization doAppInitAfterRestart="true">
        <add initializationPage="/" />
    </applicationInitialization>

  </system.webServer>
</configuration>
