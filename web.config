<!-- 
  Este archivo de configuración está optimizado para Next.js 14+ y iisnode.
  
  Puntos Clave:
  1. Reescribe todas las solicitudes para que sean manejadas por el servidor de Next.js (server.js).
  2. Permite que IIS sirva directamente los archivos estáticos de la carpeta `_next/static`, mejorando el rendimiento.
  3. Previene reinicios inesperados al guardar datos en la base de datos (archivos .db) mediante la configuración de `watchedFiles`.
-->
<configuration>
  <system.webServer>
    <handlers>
      <!-- Indica que iisnode debe manejar el archivo server.js -->
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>

    <rewrite>
      <rules>
        <!-- Regla 1: No reescribir las solicitudes para los archivos estáticos de Next.js -->
        <rule name="NextJs_Static" stopProcessing="true">
          <match url="^(_next/static/.*)" />
          <action type="None" />
        </rule>

        <!-- Regla 2: Reescribir todas las demás solicitudes a server.js para que Next.js las maneje -->
        <rule name="NextJs_Router" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
          </conditions>
          <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>

    <!-- 
      ¡CONFIGURACIÓN CRÍTICA PARA ESTABILIDAD!
      - `watchedFiles`: Le decimos a iisnode que solo vigile `server.js`. De esta forma,
        los cambios en la carpeta `dbs/` o en `temp_files/` NO provocarán un reinicio.
      - `loggingEnabled`: Habilita la creación de logs en la carpeta `iisnode/` para depuración.
      - `devErrorsEnabled`: Muestra errores detallados en el navegador (solo para desarrollo).
    -->
    <iisnode 
      watchedFiles="server.js" 
      loggingEnabled="true" 
      devErrorsEnabled="true" 
      nodeProcessCommandLine="&quot;%programfiles%\nodejs\node.exe&quot;"
    />

    <!--
      Asegúrate de que el módulo de reescritura de URL esté instalado en IIS.
      https://www.iis.net/downloads/microsoft/url-rewrite
    -->
    
  </system.webServer>
</configuration>